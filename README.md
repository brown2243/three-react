# 다시 하는 ThreeJS 학습

## [shadows](https://threejs.org/manual/#ko/shadows)

3D 그래픽에서 그림자란 그리 간단한 주제가 아닙니다.
그림자를 구현하는 방법은 아주 많지만 모두 단점이 있기에 어떤 것이 가장 효율적이라고 말하기 어렵습니다.

Three.js는 기본적으로 그림자 맵(shadow maps)을 사용합니다. **그림자 맵이란 그림자를 만드는 빛의 영향을 받는, 그림자를 드리우는 모든 물체를 빛의 시점에서 렌더링하는 기법을 말합니다. 중요하니 한 번 더 읽어보세요!**

다시 말해, 공간 안에 20개의 물체와 5개의 조명이 있고, 20개의 물체 모두 그림자를 드리우며 5개의 조명 모두 그림자를 지게 한다면, 한 장면을 만들기 위해 총 6번 화면을 렌더링할 것이라는 이야기입니다. 먼저 조명 1번에 대해 20개의 물체를 전부 렌더링하고, 다음에는 2번 조명, 그 다음에는 3번... 이렇게 처음 5번 렌더링한 결과물을 합쳐 최종 결과물을 만드는 것이죠.

만약 여기에 포인트(point) 조명을 하나 추가하면 조명 하나 때문에 6번을 다시 렌더링해야 합니다.

이 때문에 그림자를 지게 하는 조명을 여러개 만들기보다 다른 방법을 찾는 경우가 보통입니다. **주로 사용하는 방법은 조명이 여러개 있어도 하나의 조명만 그림자를 지게끔 설정하는 것이죠.**

물론 라이트맵(lightmaps)이나 앰비언트 오클루전(ambient occlusion)을 이용해 빛의 영향을 미리 계산할 수도 있습니다. 이러면 정적 조명이나 정적 빛 반사를 사용하는 것이기에 수정하기가 어렵지만, 적어도 성능은 빠릅니다. 이 두 가지 모두 나중에 별도로 다룰 것입니다.

**가짜 그림자를 사용하는 방법도 있습니다. 평면을 만들고, 흑백 텍스처를 입혀 땅 위에 그림자가 있을 만한 위치에 가져다 놓는 것이죠.**

depthWrite 속성을 false로 설정해 그림자끼리 충돌하는 현상을 막습니다. 이 충돌 현상은 다른 글에서 더 자세히 이야기할 거예요. 그림자는 빛을 반사하지 않으니 MeshBasicMaterial을 사용합니다.

**이런, 그림자 일부가 잘려나간 것이 보이나요? 이는 빛의 시점에서 장면을 렌더링해 그림자 맵을 만들기 때문입니다.** 위 예제를 예로 들면 DirectionalLight의 위치에 카메라가 있고, 해당 조명의 목표를 바라보는 것이죠.
조명의 그림자에는 별도의 카메라가 있고, 이전에 카메라에 관한 글에서 설명한 것처럼 일정 공간 안의 그림자만 렌더링합니다. 위 예제에서는 그 공간이 너무 좁은 것이죠.

어째서 width와 height를 완전 큰 값으로 설정해 모든 요소를 다 포함하도록 하지 않는 걸까요? width와 height를 100 정도로 설정하면 그림자의 해상도가 낮아집니다.
왜 그림자의 해상도가 낮아졌을까요?

**이는 그림자 관련 설정을 할 때 항상 주의해야하는 부분입니다. 사실 그림자 맵은 그림자가 포함된 하나의 텍스처입니다. 이 텍스처는 크기가 정해져 있죠.** 위 예제에서 카메라의 공간을 늘리면, 이 텍스처 또한 늘어납니다. 다시 말해 공간을 크게 설정할수록 그림자가 더 각져 보일 거라는 얘기죠.

그림자 맵의 해상도는 light.shadow.mapSize 속성의 width와 height 속성으로 설정합니다(기본값은 512x512). **그림자 맵은 크게 설정할수록 메모리를 많이 차지하고, 연산이 더 복잡해지므로 가능한 작게 설정하는 것이 좋습니다. 이는 그림자용 카메라의 공간도 마찬가지죠. 작을 수록 그림자의 퀄리티가 좋아질 테니 가능한 공간을 작게 설정하는 것이 좋습니다.** 또한 기기마다 렌더링할 수 있는 텍스처의 용량이 정해져 있으니 주의해야 합니다. Three.js에서 이 용량은 renderer.capabilities.maxTextureSize로 확인할 수 있습니다.

SpotLight는 그림자용 카메라로 PerspectiveCamera(원근 카메라)를 사용합니다. DirectionalLight의 그림자용 카메라는 거의 모든 속성을 직접 변경할 수 있었지만, SpotLight의 그림자용 카메라는 조명 속성의 영향을 받습니다. 카메라의 fov 속성은 SpotLight의 angle 속성과 직접 연결되어 있죠. aspect는 그림자 맵의 크기에 따라 자동으로 정해집니다.
